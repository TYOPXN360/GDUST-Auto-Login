# å¹¿ä¸œç§‘æŠ€å­¦é™¢(å—åŸæ ¡åŒº)æ ¡å›­ç½‘ä¸€é”®è®¤è¯ç™»å½•è„šæœ¬
param(
    [switch]$y,  # è‡ªåŠ¨å¼€å¯é˜²æ–­è”
    [switch]$n   # è‡ªåŠ¨å…³é—­é˜²æ–­è”ï¼ˆä¸-yäº’æ–¥ï¼‰
)

Add-Type -AssemblyName System.Web

# --------------------------
# å·¥å…·å‡½æ•°1ï¼šæŒ‰ä»»æ„é”®é€€å‡º
# --------------------------
function WaitForKeyAndExit {
    param([int]$ExitCode = 0)
    Write-Host "`næŒ‰ä»»æ„é”®é€€å‡º..." -ForegroundColor Cyan
    $null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
    Exit $ExitCode
}

# --------------------------
# å·¥å…·å‡½æ•°2ï¼šå‚æ•°å†²çªæ£€æŸ¥
# --------------------------
function Check-ParamConflict {
    if ($y -and $n) {
        Write-Host "âŒ é”™è¯¯ï¼š-yå’Œ-nå‚æ•°ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼Œè¯·ä»…é€‰æ‹©å…¶ä¸­ä¸€ä¸ª" -ForegroundColor Red
        WaitForKeyAndExit -ExitCode 1
    }
}

# --------------------------
# å·¥å…·å‡½æ•°3ï¼šè¯»å–/ä¿å­˜è´¦å·å¯†ç ï¼ˆå»é™¤å†…ç½®è´¦å·å¯†ç ï¼Œé¦–æ¬¡å¼ºåˆ¶è¾“å…¥ï¼‰
# --------------------------
function Get-AccountInfo {
    # åˆå§‹åŒ–è´¦å·å¯†ç å˜é‡ï¼ˆä¸ºç©ºï¼Œæ— å†…ç½®å€¼ï¼Œé¦–æ¬¡è¿è¡Œå¿…æç¤ºè¾“å…¥ï¼‰
    $savedUsername = ""
    $savedPassword = ""

    # è‹¥å·²ä¿å­˜è´¦å·å¯†ç ï¼Œç›´æ¥è¿”å›ï¼›å¦åˆ™å¼ºåˆ¶æç¤ºè¾“å…¥
    if (-not [string]::IsNullOrWhiteSpace($savedUsername) -and -not [string]::IsNullOrWhiteSpace($savedPassword)) {
        return $savedUsername, $savedPassword
    }

    # å¼ºåˆ¶æç¤ºç”¨æˆ·è¾“å…¥ï¼ˆæ— å†…ç½®å€¼ï¼Œå¿…é¡»æ‰‹åŠ¨å¡«å†™ï¼‰
    Write-Host "`næœªæ£€æµ‹åˆ°å·²ä¿å­˜çš„è´¦å·å¯†ç ï¼Œè¯·è¾“å…¥æ ¡å›­ç½‘è®¤è¯ä¿¡æ¯" -ForegroundColor Cyan
    $username = Read-Host "è¯·è¾“å…¥è´¦å·ï¼ˆé€šå¸¸ä¸ºå­¦å·ï¼‰"
    while ([string]::IsNullOrWhiteSpace($username)) {
        Write-Host "âŒ è´¦å·ä¸èƒ½ä¸ºç©ºï¼" -ForegroundColor Red
        $username = Read-Host "è¯·é‡æ–°è¾“å…¥è´¦å·"
    }

    $password = Read-Host "è¯·è¾“å…¥å¯†ç " -AsSecureString
    $passwordPlain = [System.Net.NetworkCredential]::new("", $password).Password
    while ([string]::IsNullOrWhiteSpace($passwordPlain)) {
        Write-Host "âŒ å¯†ç ä¸èƒ½ä¸ºç©ºï¼" -ForegroundColor Red
        $password = Read-Host "è¯·é‡æ–°è¾“å…¥å¯†ç " -AsSecureString
        $passwordPlain = [System.Net.NetworkCredential]::new("", $password).Password
    }

    # å¯é è·å–è„šæœ¬è·¯å¾„ï¼ˆå…¼å®¹æ‰€æœ‰ç¯å¢ƒï¼‰
    try {
        # æ–¹æ³•1ï¼šä¼˜å…ˆä½¿ç”¨$PSCommandPathï¼ˆPowerShell 3.0+æ›´å¯é ï¼‰
        if (-not [string]::IsNullOrWhiteSpace($PSCommandPath)) {
            $scriptPath = $PSCommandPath
        }
        # æ–¹æ³•2ï¼š fallbackåˆ°$MyInvocationï¼ˆå…¼å®¹ä½ç‰ˆæœ¬ï¼‰
        else {
            $scriptPath = $MyInvocation.MyCommand.Path
        }

        # éªŒè¯è·¯å¾„æ˜¯å¦æœ‰æ•ˆ
        if (-not (Test-Path -Path $scriptPath -PathType Leaf)) {
            throw "è„šæœ¬è·¯å¾„æ— æ•ˆï¼Œè¯·åç»­æ‰‹åŠ¨ä¿®æ”¹è„šæœ¬ä¿å­˜è´¦å·å¯†ç "
        }

        # è¯»å–è„šæœ¬å†…å®¹ï¼ˆå…¼å®¹æ‰€æœ‰ç‰ˆæœ¬ï¼‰
        $scriptContent = (Get-Content -Path $scriptPath) -join "`n"

        # æ›¿æ¢è´¦å·å¯†ç ï¼ˆç²¾ç¡®åŒ¹é…ç©ºå˜é‡è¡Œï¼Œå†™å…¥ç”¨æˆ·è¾“å…¥çš„å€¼ï¼‰
        $updatedContent = $scriptContent -replace '(?m)^(\s*)\$savedUsername\s*=\s*""', "`$1`$savedUsername = `"$username`"" `
                                        -replace '(?m)^(\s*)\$savedPassword\s*=\s*""', "`$1`$savedPassword = `"$passwordPlain`""

        # å†™å…¥è„šæœ¬ï¼ˆä¿å­˜åä¸‹æ¬¡æ— éœ€è¾“å…¥ï¼‰
        Set-Content -Path $scriptPath -Value $updatedContent -Force
        Write-Host "âœ… è´¦å·å¯†ç å·²ä¿å­˜ï¼Œä¸‹æ¬¡è¿è¡Œæ— éœ€é‡å¤è¾“å…¥" -ForegroundColor Green
    } catch {
        Write-Host "âš ï¸ è­¦å‘Šï¼šè‡ªåŠ¨ä¿å­˜è´¦å·å¯†ç å¤±è´¥ï¼ˆå¯èƒ½æ— è„šæœ¬å†™å…¥æƒé™ï¼‰" -ForegroundColor Yellow
        Write-Host "   é”™è¯¯åŸå› ï¼š$_" -ForegroundColor Yellow
        Write-Host "   æ‰‹åŠ¨ä¿å­˜æ–¹æ³•ï¼šç”¨è®°äº‹æœ¬æ‰“å¼€è„šæœ¬ï¼Œæ‰¾åˆ°ä»¥ä¸‹ä¸¤è¡Œå¡«å…¥ä¿¡æ¯ï¼š" -ForegroundColor Yellow
        Write-Host "   `$savedUsername = `"ä½ çš„è´¦å·`"" -ForegroundColor Yellow
        Write-Host "   `$savedPassword = `"ä½ çš„å¯†ç `"" -ForegroundColor Yellow
    }

    return $username, $passwordPlain
}

# --------------------------
# å·¥å…·å‡½æ•°4ï¼šæå–æœåŠ¡å™¨è¿”å›ä¸­æ–‡
# --------------------------
function Get-ChineseContent {
    param([string]$InputContent)
    $cleanContent = $InputContent -replace "<.*?>", "" `
        -replace '"å¾®è½¯é›…é»‘"|"å®‹ä½“"|"é»‘ä½“|Helvetica|Arial|sans-serif', "" `
        -replace '""|,""|,"|[a-zA-Z0-9_./?&=;:+-]+', "" `
        -replace "\s+", " " `
        -replace '[^\u4e00-\u9fa5ï¼Œã€‚ï¼ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘ã€â€¦ ]', ""
    $cleanContent = $cleanContent.Trim()
    
    $chinesePattern = '([\u4e00-\u9fa5ï¼Œã€‚ï¼ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘ã€â€¦ ]{2,})'
    $chineseMatches = [regex]::Matches($cleanContent, $chinesePattern)
    $chineseContent = $chineseMatches | ForEach-Object { $_.Value.Trim() } | Where-Object { $_ -ne "" } | Select-Object -Unique
    return $chineseContent -join "ï¼›"
}

# --------------------------
# å·¥å…·å‡½æ•°5ï¼šæ ¸å¿ƒè®¤è¯æµç¨‹ï¼ˆæ”¯æŒWi-Fi/WLAN/Ethernet/Fast/connectç½‘å¡ï¼‰
# --------------------------
function Start-AuthFlow {
    param(
        [string]$Username,
        [string]$Password,
        [string]$Basip = "172.18.100.100",
        [bool]$IsReconnect = $false
    )

    # æ­¥éª¤1ï¼šè·å–ç½‘å¡ä¿¡æ¯ï¼ˆåŒ¹é…ç‰©ç†ç½‘å¡ï¼Œæ’é™¤è™šæ‹Ÿç½‘å¡ï¼‰
    try {
        $adapter = Get-NetAdapter | Where-Object {
            # åŒ¹é…ç‰©ç†ç½‘å¡ï¼šWi-Fi/WLAN/Ethernet/Fast/connectç›¸å…³åç§°
            ($_.InterfaceDescription -match "WLAN|Wi-Fi|Ethernet|Fast|connect") -and
            # æ’é™¤è™šæ‹Ÿç½‘å¡ï¼šHyper-Vç›¸å…³æˆ–vEthernetï¼ˆè™šæ‹Ÿäº¤æ¢æœºï¼‰
            $_.InterfaceDescription -notmatch "Hyper-V|vEthernet" -and
            # ç¡®ä¿ç½‘å¡çŠ¶æ€ä¸ºå¯ç”¨
            $_.Status -eq "Up"
        } | ForEach-Object {
            # è·å–IPv4åœ°å€ï¼ˆå¿½ç•¥æ— IPçš„ç½‘å¡ï¼‰
            $ipv4Addr = $_ | Get-NetIPAddress -AddressFamily IPv4 -ErrorAction SilentlyContinue
            if ($ipv4Addr) {
                $_ | Add-Member -NotePropertyName "IPv4Address" -NotePropertyValue $ipv4Addr.IPAddress -PassThru
            }
        } | Select-Object -First 1  # ä¼˜å…ˆé€‰æ‹©ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ç½‘å¡

        if (-not $adapter) {
            Write-Host "[é”™è¯¯] æœªæ‰¾åˆ°å¯ç”¨ç½‘å¡ï¼ˆéœ€å¯ç”¨å«Wi-Fi/WLAN/Ethernet/Fast/connectçš„ç‰©ç†ç½‘å¡ï¼Œæ’é™¤Hyper-Vè™šæ‹Ÿç½‘å¡ï¼‰" -ForegroundColor Red
            return $false, $null, $null
        }

        $wlanUserIp = $adapter.IPv4Address
        $clientMac = $adapter.MacAddress
        $timestamp = [Math]::Floor([decimal](Get-Date -UFormat %s))
        
        # åŒºåˆ†é¦–æ¬¡è®¤è¯å’Œé‡è¿çš„åŸºç¡€ä¿¡æ¯æç¤º
        if ($IsReconnect) {
            Write-Host "[é‡è¿-åŸºç¡€ä¿¡æ¯] ç½‘å¡ï¼š$($adapter.InterfaceDescription) | IPï¼š$wlanUserIp | MACï¼š$clientMac" -ForegroundColor Cyan
        } else {
            Write-Host "[é¦–æ¬¡è®¤è¯-åŸºç¡€ä¿¡æ¯] ç½‘å¡ï¼š$($adapter.InterfaceDescription) | IPï¼š$wlanUserIp | MACï¼š$clientMac" -ForegroundColor Cyan
        }
    } catch {
        Write-Host "[é”™è¯¯] è·å–ç½‘å¡å‚æ•°å¤±è´¥ï¼š$_" -ForegroundColor Red
        return $false, $null, $null
    }

    # æ­¥éª¤2ï¼šåˆå§‹è®¤è¯ï¼ˆè·å–äºŒæ¬¡è®¤è¯åœ°å€ï¼‰
    $webSession = New-Object Microsoft.PowerShell.Commands.WebRequestSession
    $ajaxUrlFromForm = $null
    try {
        $mainUrl = "http://8.135.34.165/lfradius/libs/portal/unify/portal.php/login/main/nasid/1/?" +
            "wlanuserip=$wlanUserIp&wlanacname=gdkjxy&clientip=$wlanUserIp&clientmac=$clientMac&" +
            "paip=$Basip&vlan=3001.0&iarmdst=www.qq.com/?time=$timestamp"

        $postParams = @{
            usrname = $Username
            passwd = $Password
            treaty = "on"
            nasid = "1"
            usrmac = $clientMac
            usrip = $wlanUserIp
            basip = $Basip
            success = "http://8.135.34.165/lfradius/libs/portal/unify/portal.php/login/success"
            fail = "http://8.135.34.165/lfradius/libs/portal/unify/portal.php/login/fail"
        }

        # æ„é€ POSTè¯·æ±‚ä½“
        $encodedKeyValues = @()
        foreach ($key in $postParams.Keys) {
            $encodedValue = [System.Web.HttpUtility]::UrlEncode($postParams[$key])
            $encodedKeyValues += "$key=$encodedValue"
        }
        $encodedBody = $encodedKeyValues -join "&"

        # åŒºåˆ†é¦–æ¬¡è®¤è¯å’Œé‡è¿çš„æ­¥éª¤æç¤º
        if ($IsReconnect) {
            Write-Host "[é‡è¿-æ­¥éª¤1] å‘é€è®¤è¯è¯·æ±‚..." -ForegroundColor Cyan
        } else {
            Write-Host "[é¦–æ¬¡è®¤è¯-æ­¥éª¤1] å‘é€åˆå§‹è®¤è¯è¯·æ±‚..." -ForegroundColor Cyan
        }
        
        $response1 = Invoke-WebRequest -Uri "http://8.135.34.165/lfradius/libs/portal/unify/portal.php/login/Panabit_login" `
            -Method Post `
            -Body $encodedBody `
            -Headers @{ 
                Referer = $mainUrl 
                "User-Agent" = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/142.0.0.0" 
                "Content-Type" = "application/x-www-form-urlencoded"
            } `
            -WebSession $webSession `
            -TimeoutSec 30 `
            -ErrorAction Stop

        if ($response1.StatusCode -eq 200) {
            $serverContent1 = if ($response1.Content -is [byte[]]) {
                try { [System.Text.Encoding]::GetEncoding("gbk").GetString($response1.Content) }
                catch { [System.Text.Encoding]::UTF8.GetString($response1.Content) }
            } else { $response1.Content }

            $chineseTip1 = Get-ChineseContent -InputContent $serverContent1
            if ($chineseTip1) { 
                if ($IsReconnect) {
                    Write-Host "[é‡è¿-æœåŠ¡å™¨æç¤º] $chineseTip1" -ForegroundColor Magenta
                } else {
                    Write-Host "[é¦–æ¬¡è®¤è¯-æœåŠ¡å™¨æç¤º] $chineseTip1" -ForegroundColor Magenta
                }
            }

            # æå–äºŒæ¬¡è®¤è¯åœ°å€
            if ($serverContent1 -match '<form name="login" action="([^"]+)" method="post"') {
                $ajaxUrlFromForm = $matches[1]
                if ($IsReconnect) {
                    Write-Host "[é‡è¿-åŸºç¡€ä¿¡æ¯] æå–è®¤è¯åœ°å€ï¼š$ajaxUrlFromForm" -ForegroundColor Cyan
                } else {
                    Write-Host "[é¦–æ¬¡è®¤è¯-åŸºç¡€ä¿¡æ¯] æå–äºŒæ¬¡è®¤è¯åœ°å€ï¼š$ajaxUrlFromForm" -ForegroundColor Cyan
                }
            }
        } else {
            throw "è®¤è¯å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š$($response1.StatusCode)"
        }
    } catch {
        Write-Host "[é”™è¯¯] è®¤è¯è¯·æ±‚å¤±è´¥ï¼š$_" -ForegroundColor Red
        return $false, $null, $null
    }

    # æ­¥éª¤3ï¼šäºŒæ¬¡è®¤è¯ï¼ˆæ ¸å¿ƒç™»å½•ï¼‰
    try {
        $ajaxParams = @{
            action = "login"
            user = $Username
            pwd = $Password
            usrmac = $clientMac
            ip = $wlanUserIp
            success = $postParams.success
            fail = $postParams.fail
        }

        # æ„é€ POSTè¯·æ±‚ä½“
        $ajaxKeyValues = @()
        foreach ($key in $ajaxParams.Keys) {
            $encodedVal = [System.Web.HttpUtility]::UrlEncode($ajaxParams[$key])
            $ajaxKeyValues += "$key=$encodedVal"
        }
        $ajaxBody = $ajaxKeyValues -join "&"

        $ajaxUrl = if ($ajaxUrlFromForm) { $ajaxUrlFromForm } else { "http://172.18.100.100:8010/cgi-bin/webauth/ajax_webauth" }
        
        # åŒºåˆ†é¦–æ¬¡è®¤è¯å’Œé‡è¿çš„æ­¥éª¤æç¤º
        if ($IsReconnect) {
            Write-Host "[é‡è¿-æ­¥éª¤2] å‘é€ç™»å½•è¯·æ±‚..." -ForegroundColor Cyan
        } else {
            Write-Host "[é¦–æ¬¡è®¤è¯-æ­¥éª¤2] å‘é€äºŒæ¬¡è®¤è¯è¯·æ±‚..." -ForegroundColor Cyan
        }
        
        $response2 = Invoke-WebRequest -Uri $ajaxUrl `
            -Method Post `
            -Body $ajaxBody `
            -Headers @{ 
                Referer = "http://8.135.34.165/" 
                Origin = "http://8.135.34.165" 
                "User-Agent" = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/142.0.0.0" 
                "Content-Type" = "application/x-www-form-urlencoded"
            } `
            -WebSession $webSession `
            -TimeoutSec 30 `
            -ErrorAction Stop

        $serverContent2 = if ($response2.Content -is [byte[]]) {
            try { [System.Text.Encoding]::GetEncoding("GB2312").GetString($response2.Content) }
            catch { [System.Text.Encoding]::UTF8.GetString($response2.Content) }
        } else { $response2.Content }

        $chineseTip2 = Get-ChineseContent -InputContent $serverContent2
        if ($chineseTip2) { 
            if ($IsReconnect) {
                Write-Host "[é‡è¿-æœåŠ¡å™¨æç¤º] $chineseTip2" -ForegroundColor Magenta
            } else {
                Write-Host "[é¦–æ¬¡è®¤è¯-æœåŠ¡å™¨æç¤º] $chineseTip2" -ForegroundColor Magenta
            }
        }

        # åŒºåˆ†é¦–æ¬¡è®¤è¯å’Œé‡è¿çš„ç»“æœæç¤º
        if ($IsReconnect) {
            Write-Host "[é‡è¿-ç»“æœ] ç™»å½•æˆåŠŸ" -ForegroundColor Green
        } else {
            Write-Host "[é¦–æ¬¡è®¤è¯-ç»“æœ] äºŒæ¬¡è®¤è¯æˆåŠŸ" -ForegroundColor Green
        }
        return $true, $wlanUserIp, $clientMac
    } catch {
        Write-Host "[é”™è¯¯] ç™»å½•è¯·æ±‚å¤±è´¥ï¼š$_" -ForegroundColor Red
        return $false, $null, $null
    }
}

# --------------------------
# ä¸»æµç¨‹ï¼šå‚æ•°æ£€æŸ¥+è´¦å·å¯†ç è·å–+è®¤è¯
# --------------------------
Check-ParamConflict

# è·å–è´¦å·å¯†ç ï¼ˆæ— å†…ç½®å€¼ï¼Œé¦–æ¬¡å¿…è¾“å…¥ï¼‰
$usrname, $passwordPlain = Get-AccountInfo

# è°ƒç”¨è®¤è¯å‡½æ•°æ‰§è¡Œé¦–æ¬¡è®¤è¯
$firstAuthSuccess, $userIp, $userMac = Start-AuthFlow -Username $usrname -Password $passwordPlain -Basip "172.18.100.100" -IsReconnect $false
if (-not $firstAuthSuccess) {
    Write-Host "[æœ€ç»ˆç»“æœ] é¦–æ¬¡è®¤è¯å¤±è´¥ï¼Œè„šæœ¬é€€å‡º" -ForegroundColor Red
    WaitForKeyAndExit -ExitCode 1
}

# --------------------------
# æ­¥éª¤4ï¼šcurléªŒè¯ç½‘ç»œè¿é€šæ€§
# --------------------------
Write-Host "`n==================================================" -ForegroundColor Cyan
Write-Host "æ­£åœ¨éªŒè¯ç½‘ç»œè¿é€šæ€§ï¼ˆcurlè¯·æ±‚bing.comï¼‰..." -ForegroundColor Cyan
$curlSuccess = $false
try {
    $curlPath = "C:\Windows\System32\curl.exe"
    $curlArgs = @("-I", "-m", "5", "-s", "-w", "%{http_code}", "https://bing.com")
    $curlOutput = & $curlPath $curlArgs 2>&1

    if ($curlOutput -match '^(200|3\d{2})$') {
        Write-Host "âœ… é¦–æ¬¡è®¤è¯æˆåŠŸï¼ç½‘ç»œå·²è¿é€šï¼ˆHTTPçŠ¶æ€ç ï¼š$matches[0]ï¼‰" -ForegroundColor Green
        Write-Host "ğŸ“Œ è®¤è¯ä¿¡æ¯ï¼š" -ForegroundColor Cyan
        Write-Host "   è´¦å·ï¼š$usrname" -ForegroundColor Cyan
        Write-Host "   IPåœ°å€ï¼š$userIp" -ForegroundColor Cyan
        Write-Host "   MACåœ°å€ï¼š$userMac" -ForegroundColor Cyan
        $curlSuccess = $true
    } else {
        $errorMsg = if ($curlOutput -is [Management.Automation.ErrorRecord]) { $curlOutput.Exception.Message } else { "HTTPçŠ¶æ€ç ï¼š$curlOutput" }
        Write-Host "âŒ é¦–æ¬¡è®¤è¯å¤±è´¥ï¼ç½‘ç»œæœªè¿é€šï¼š$errorMsg" -ForegroundColor Red
    }
} catch {
    Write-Host "âŒ é¦–æ¬¡è®¤è¯å¤±è´¥ï¼curlæ‰§è¡Œå¼‚å¸¸ï¼š$_" -ForegroundColor Red
}
Write-Host "==================================================" -ForegroundColor Cyan

# è‹¥curléªŒè¯å¤±è´¥ï¼ŒæŒ‰ä»»æ„é”®é€€å‡º
if (-not $curlSuccess) {
    WaitForKeyAndExit -ExitCode 1
}

# --------------------------
# é˜²æ–­è”é€»è¾‘ï¼ˆæ”¯æŒ-y/-nå‚æ•°ï¼Œäº¤äº’å¼åé¦ˆï¼‰
# --------------------------
if ($y) {
    Write-Host "`næ£€æµ‹åˆ°å‚æ•°-yï¼ŒæˆåŠŸå¼€å¯é˜²æ–­è”è¿›ç¨‹ï¼ï¼ˆæ­£å¸¸æ— è¾“å‡ºï¼Œä»…é”™è¯¯æ—¶æé†’ï¼ŒæŒ‰ Ctrl+C é€€å‡ºï¼‰" -ForegroundColor Green
    Write-Host "==================================================" -ForegroundColor Cyan
    $startAntiDisconnect = $true
} elseif ($n) {
    Write-Host "`næ£€æµ‹åˆ°å‚æ•°-nï¼Œè‡ªåŠ¨ä¸å¼€å¯é˜²æ–­è”è¿›ç¨‹ï¼Œè„šæœ¬é€€å‡º" -ForegroundColor Green
    $startAntiDisconnect = $false
} else {
    do {
        Write-Host "`næ˜¯å¦å¼€å¯é˜²æ–­è”è¿›ç¨‹ï¼Ÿï¼ˆæ­£å¸¸æ— æç¤ºï¼Œä»…é”™è¯¯æ—¶æé†’ï¼ŒæŒ‰ Ctrl+C é€€å‡ºï¼‰[Y/N]" -ForegroundColor Cyan
        $userInput = Read-Host "è¯·è¾“å…¥ Y æˆ– N"
        $userInput = $userInput.Trim().ToUpper()
        if ($userInput -notin "Y", "N") {
            Write-Host "âŒ è¾“å…¥æ— æ•ˆï¼è¯·ä»…è¾“å…¥ Yï¼ˆæ˜¯ï¼‰æˆ– Nï¼ˆå¦ï¼‰" -ForegroundColor Red
        }
    } while ($userInput -notin "Y", "N")
    
    if ($userInput -eq "Y") {
        $startAntiDisconnect = $true
        # äº¤äº’å¼å¼€å¯åé¦ˆ
        Write-Host "`nâœ… æˆåŠŸå¼€å¯é˜²æ–­è”è¿›ç¨‹ï¼ï¼ˆæ­£å¸¸æ— è¾“å‡ºï¼Œä»…é”™è¯¯æ—¶æé†’ï¼ŒæŒ‰ Ctrl+C é€€å‡ºï¼‰" -ForegroundColor Green
        Write-Host "==================================================" -ForegroundColor Cyan
    } else {
        $startAntiDisconnect = $false
    }
}

# æ‰§è¡Œé˜²æ–­è”æˆ–é€€å‡º
if ($startAntiDisconnect) {
    while ($true) {
        Start-Sleep -Seconds 5
        try {
            $curlOutputLoop = & $curlPath $curlArgs 2>&1
            if (-not ($curlOutputLoop -match '^(200|3\d{2})$')) {
                Write-Host "`n==================================================" -ForegroundColor Red
                Write-Host "âŒ ç½‘ç»œæ–­å¼€ï¼å¼€å§‹å°è¯•é‡è¿..." -ForegroundColor Red
                Write-Host "==================================================" -ForegroundColor Red
                
                $reconnectSuccess, $reconnectIp, $reconnectMac = Start-AuthFlow -Username $usrname -Password $passwordPlain -Basip "172.18.100.100" -IsReconnect $true
                
                if ($reconnectSuccess) {
                    $reconnectCurl = & $curlPath $curlArgs 2>&1
                    if ($reconnectCurl -match '^(200|3\d{2})$') {
                        Write-Host "`nâœ… é‡è¿æˆåŠŸï¼ç½‘ç»œå·²æ¢å¤" -ForegroundColor Green
                        Write-Host "ğŸ“Œ å½“å‰è¿æ¥ä¿¡æ¯ï¼š" -ForegroundColor Cyan
                        Write-Host "   è´¦å·ï¼š$usrname" -ForegroundColor Cyan
                        Write-Host "   IPåœ°å€ï¼š$reconnectIp" -ForegroundColor Cyan
                        Write-Host "   MACåœ°å€ï¼š$reconnectMac" -ForegroundColor Cyan
                        Write-Host "==================================================" -ForegroundColor Green
                    } else {
                        Write-Host "`nâŒ é‡è¿å¤±è´¥ï¼ç½‘ç»œä»æœªè¿é€š" -ForegroundColor Red
                        Write-Host "[æœ€ç»ˆç»“æœ] é‡è¿å¤±è´¥ï¼Œè„šæœ¬é€€å‡º" -ForegroundColor Red
                        WaitForKeyAndExit -ExitCode 1
                    }
                } else {
                    Write-Host "`nâŒ é‡è¿å¤±è´¥ï¼è®¤è¯æµç¨‹æ‰§è¡Œé”™è¯¯" -ForegroundColor Red
                    Write-Host "[æœ€ç»ˆç»“æœ] é‡è¿å¤±è´¥ï¼Œè„šæœ¬é€€å‡º" -ForegroundColor Red
                    WaitForKeyAndExit -ExitCode 1
                }
            }
        } catch {
            Write-Host "`nâŒ é˜²æ–­è”æ£€æµ‹å¼‚å¸¸ï¼š$_" -ForegroundColor Red
            Write-Host "[æœ€ç»ˆç»“æœ] æ£€æµ‹å¼‚å¸¸ï¼Œè„šæœ¬é€€å‡º" -ForegroundColor Red
            WaitForKeyAndExit -ExitCode 1
        }
    }
} else {
    Write-Host "`nâœ… å·²é€‰æ‹©ä¸å¼€å¯é˜²æ–­è”ï¼Œè„šæœ¬æ­£å¸¸é€€å‡º" -ForegroundColor Green
    WaitForKeyAndExit -ExitCode 0
}
